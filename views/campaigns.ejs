<%- include("partials/header") -%>

<style>
    /* Enhanced Token UI Styles */
    .token-visualization {
        position: relative;
        border-radius: 12px;
        overflow: hidden;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }
    
    .token-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 2;
        font-size: 0.7rem;
        padding: 0.35em 0.65em;
        letter-spacing: 0.5px;
        text-transform: uppercase;
        background: rgba(0,0,0,0.7);
        color: white;
        border-radius: 50rem;
        transition: all 0.3s ease;
    }
    
    /* Campaign card enhancements */
    .campaign-card {
        border: 1px solid rgba(0,0,0,0.03);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }
    
    .campaign-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 14px 28px rgba(0,0,0,0.1);
        border-color: rgba(0,0,0,0.1);
    }
    
    .campaign-image-container {
        height: 180px;
        overflow: hidden;
        position: relative;
    }
    
    .campaign-image {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.5s ease;
    }
    
    .campaign-card:hover .campaign-image {
        transform: scale(1.05);
    }
    
    .campaign-card:hover .token-badge {
        transform: scale(1.1);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Badge colors */
    .profit-badge { background-color: #0dcaf0; }
    .equity-badge { background-color: #0d6efd; }
    .hybrid-badge { background-color: #198754; }
    .rewards-badge { background-color: #ffc107; color: #000; }
    
    /* Investment calculator */
    .investment-preview {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 15px;
    }
    
    .investment-progress-container {
        height: 6px;
        background: rgba(0,0,0,0.05);
        border-radius: 3px;
        margin: 10px 0;
    }
    
    .investment-progress {
        height: 100%;
        background: linear-gradient(90deg, #2575fc 0%, #6a11cb 100%);
        border-radius: 3px;
        transition: width 0.4s ease;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .campaign-image-container {
            height: 150px;
        }
        
        .token-badge {
            font-size: 0.6rem;
            padding: 0.25em 0.5em;
        }
    }
</style>

<body>
    <div class="container-fluid px-lg-5 py-4">
        <!-- Campaign Filter Bar -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">Available Campaigns</h2>
            <div class="d-flex gap-2">
                <% if(currentUser) { %>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                        <i class="bi bi-plus-circle"></i> Create Campaign
                    </button>
                <% } %>
            </div>
        </div>

        <% if(campaigns.length < 1) { %>
            <div class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <i class="bi bi-emoji-frown fs-1 text-muted mb-3"></i>
                    <h4 class="text-muted">No campaigns available yet</h4>
                    <p class="text-muted">Be the first to create a tokenized campaign!</p>
                    <% if(currentUser) { %>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCampaignModal">
                            <i class="bi bi-rocket"></i> Launch Campaign
                        </button>
                    <% } else { %>
                        <a href="/register" class="btn btn-primary">
                            <i class="bi bi-person-plus"></i> Register to Create
                        </a>
                    <% } %>
                </div>
            </div>
        <% } %>

        <!-- Campaign Grid -->
        <div class="row row-cols-1 row-cols-sm-2 row-cols-xl-3 row-cols-xxl-4 g-4">
            <% campaigns.forEach(campaign => { %>
                <div class="col">
                    <div class="card campaign-card h-100">
                        <!-- Campaign Image -->
                        <div class="campaign-image-container">
                            <% if(campaign.image) { %>
                                <img src="<%= campaign.image %>" class="campaign-image" alt="<%= campaign.title %>">
                            <% } else { %>
                                <div class="h-100 d-flex align-items-center justify-content-center" 
                                     style="background: linear-gradient(135deg, <%= 
                                     campaign.tokenType === 'profit' ? '#0dcaf0' : 
                                     campaign.tokenType === 'ownership' ? '#0d6efd' : '#198754' %>, #6c757d);">
                                    <h4 class="text-white m-0"><%= campaign.tokenSymbol || 'TKN' %></h4>
                                </div>
                            <% } %>
                            <span class="token-badge <%= 
                                campaign.tokenType === 'profit' ? 'profit-badge' : 
                                campaign.tokenType === 'ownership' ? 'equity-badge' : 'hybrid-badge' 
                            %>">
                                <i class="bi bi-<%= 
                                    campaign.tokenType === 'profit' ? 'graph-up' : 
                                    campaign.tokenType === 'ownership' ? 'building' : 'collection' 
                                %>"></i>
                                <%= campaign.tokenType.charAt(0).toUpperCase() + campaign.tokenType.slice(1) %>
                            </span>
                        </div>

                        <!-- Campaign Body -->
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h5 class="card-title mb-1"><%= campaign.title %></h5>
                                    <small class="text-muted">
                                        by <%= campaign.owner.username %>
                                    </small>
                                </div>
                                <span class="badge bg-<%= 
                                    campaign.status === 'active' ? 'success' : 
                                    campaign.status === 'funded' ? 'primary' : 'secondary' 
                                %>">
                                    <%= campaign.status.toUpperCase() %>
                                </span>
                            </div>

                            <p class="card-text text-muted mb-3" style="min-height: 60px;">
                                <%= campaign.description.substring(0, 100) %><%= campaign.description.length > 100 ? '...' : '' %>
                            </p>

                            <!-- Enhanced Tokenomics Visualization -->
                            <div class="token-visualization p-3 mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">TOKEN VALUE</small>
                                    <strong>$<%= (campaign.goalAmount / campaign.totalTokens).toFixed(2) %></strong>
                                </div>
                                
                                <div class="progress" style="height: 8px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                         role="progressbar" 
                                         style="width: <%= Math.min((campaign.amountRaised / campaign.goalAmount) * 100, 100) %>%; 
                                                background-color: <%= 
                                                  campaign.tokenType === 'profit' ? '#20c997' : 
                                                  campaign.tokenType === 'ownership' ? '#0d6efd' : '#6f42c1' %>">
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-currency-dollar"></i> <%= campaign.amountRaised.toLocaleString() %>
                                    </small>
                                    <small class="text-muted">
                                        <i class="bi bi-bullseye"></i> <%= campaign.goalAmount.toLocaleString() %>
                                    </small>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="d-grid gap-2">
                                <a href="/campaigns/<%= campaign._id %>" class="btn btn-outline-primary">
                                    <i class="bi bi-eye"></i> View Details
                                </a>
                                
                                <% if(currentUser && currentUser._id.equals(campaign.owner._id)) { %>
                                    <div class="btn-group">
                                        <button class="btn btn-outline-secondary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editCampaignModal"
                                                onclick="loadEditForm('<%= campaign._id %>')">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button type="button" class="btn btn-outline-danger" 
                                                onclick="confirmDelete('<%= campaign._id %>')">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </div>
                                <% } else if(currentUser) { %>
                                    <button class="btn btn-success" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#investModal"
                                            onclick="setupInvestmentModal(
                                                '<%= campaign._id %>',
                                                '<%= campaign.title %>',
                                                '<%= campaign.tokenType %>',
                                                '<%= campaign.tokenSymbol %>',
                                                <%= campaign.goalAmount %>,
                                                <%= campaign.totalTokens %>,
                                                <%= campaign.tokenMetadata.profitSharePercentage || 0 %>,
                                                <%= campaign.tokenMetadata.ownershipPercentage || 0 %>,
                                                '<%= campaign.tokenMetadata.ownershipPerToken || '' %>'
                                            )">
                                        <i class="bi bi-currency-dollar"></i> Invest Now
                                    </button>
                                <% } else { %>
                                    <a href="/login?redirect=/campaigns" class="btn btn-warning">
                                        <i class="bi bi-box-arrow-in-right"></i> Login to Invest
                                    </a>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    </div>

    <!-- Create Campaign Modal -->
    <div class="modal fade" id="createCampaignModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createCampaignForm" action="/campaigns/create" method="POST" enctype="multipart/form-data">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="title" class="form-label">Campaign Title *</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="col-md-6">
                                <label for="goalAmount" class="form-label">Goal Amount ($) *</label>
                                <input type="number" class="form-control" id="goalAmount" name="goalAmount" min="1" required>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="description" class="form-label">Description *</label>
                            <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label for="campaignImage" class="form-label">Campaign Image</label>
                            <input class="form-control" type="file" id="campaignImage" name="image" accept="image/*">
                        </div>
                        
                        <!-- Token Configuration -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h5 class="mb-0">Token Configuration</h5>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="tokenType" class="form-label">Token Type *</label>
                                        <select class="form-select" id="tokenType" name="tokenType" required>
                                            <option value="">Select Token Type</option>
                                            <option value="profit">Profit Share</option>
                                            <option value="ownership">Ownership</option>
                                            <option value="hybrid">Hybrid</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="tokenSymbol" class="form-label">Token Symbol *</label>
                                        <input type="text" class="form-control" id="tokenSymbol" name="tokenSymbol" 
                                            maxlength="8" required pattern="[A-Z0-9]{3,8}" placeholder="e.g., SOLAR">
                                    </div>
                                </div>
                                
                                <!-- Dynamic Token Fields -->
                                <div id="profitFields" class="token-fields" style="display:none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="profitSharePercentage" class="form-label">Profit Share % *</label>
                                            <input type="number" class="form-control" id="profitSharePercentage" 
                                                name="profitSharePercentage" min="1" max="100" value="10" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="profitDistributionFrequency" class="form-label">Distribution *</label>
                                            <select class="form-select" id="profitDistributionFrequency" 
                                                name="profitDistributionFrequency" required>
                                                <option value="monthly">Monthly</option>
                                                <option value="quarterly" selected>Quarterly</option>
                                                <option value="annually">Annually</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="ownershipFields" class="token-fields" style="display:none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="ownershipPercentage" class="form-label">Ownership % *</label>
                                            <input type="number" class="form-control" id="ownershipPercentage" 
                                                name="ownershipPercentage" min="1" max="100" value="10" required>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check mt-4 pt-2">
                                                <input class="form-check-input" type="checkbox" id="votingRights" name="votingRights">
                                                <label class="form-check-label" for="votingRights">Include Voting Rights</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="hybridFields" class="token-fields" style="display:none;">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label for="ownershipPerToken" class="form-label">Ownership Per Token *</label>
                                            <input type="number" step="0.01" class="form-control" id="ownershipPerToken" 
                                                name="ownershipPerToken" min="0.01" value="0.1" required>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="hybridRewardDescription" class="form-label">Reward Description *</label>
                                            <input type="text" class="form-control" id="hybridRewardDescription" 
                                                name="hybridRewardDescription" required>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Create Campaign
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Invest Modal -->
    <div class="modal fade" id="investModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="investModalTitle">Invest in Campaign</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="investForm" action="/campaigns/invest" method="POST">
                        <input type="hidden" id="campaignId" name="campaignId">
                        <input type="hidden" id="tokenType" name="tokenType">
                        
                        <div class="mb-3">
                            <label for="investAmount" class="form-label">Investment Amount ($)</label>
                            <div class="input-group mb-2">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="investAmount" 
                                       name="amount" min="1" required oninput="updateTokenPreview()">
                            </div>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="range" class="form-range" id="investRange" 
                                       min="1" max="10000" step="1" 
                                       oninput="document.getElementById('investAmount').value = this.value; updateTokenPreview()">
                            </div>
                            <div class="d-flex justify-content-between small text-muted mt-1">
                                <span>$1</span>
                                <span>$5,000</span>
                                <span>$10,000+</span>
                            </div>
                        </div>
                        
                        <div class="investment-preview mb-3">
                            <h6 class="mb-3"><i class="bi bi-lightning-charge"></i> You'll Receive</h6>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span>Token Type:</span>
                                <strong id="previewTokenType"></strong>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Token Symbol:</span>
                                <strong id="previewTokenSymbol"></strong>
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <span>Token Amount:</span>
                                <strong id="previewTokenAmount">0 tokens</strong>
                            </div>
                            
                            <div class="investment-progress-container">
                                <div class="investment-progress" style="width: 0%"></div>
                            </div>
                            
                            <div class="text-center mt-2">
                                <small class="text-muted" id="previewTokenValue">Enter amount to see details</small>
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success">
                                <i class="bi bi-currency-dollar"></i> Confirm Investment
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Bootstrap tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Token type dropdown functionality
        document.getElementById('tokenType').addEventListener('change', function() {
            // Hide all token fields
            document.querySelectorAll('.token-fields').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected token type fields
            const selectedType = this.value;
            if (selectedType) {
                document.getElementById(selectedType + 'Fields').style.display = 'block';
            }
        });

        // Investment modal setup
        function setupInvestmentModal(
            campaignId, 
            campaignTitle, 
            tokenType, 
            tokenSymbol, 
            goalAmount, 
            totalTokens, 
            profitShare, 
            ownershipPercentage,
            ownershipPerToken
        ) {
            document.getElementById('investModalTitle').textContent = `Invest in ${campaignTitle}`;
            document.getElementById('campaignId').value = campaignId;
            document.getElementById('tokenType').value = tokenType;
            document.getElementById('previewTokenType').textContent = 
                tokenType.charAt(0).toUpperCase() + tokenType.slice(1);
            document.getElementById('previewTokenSymbol').textContent = tokenSymbol;
            
            // Store additional data for calculations
            document.getElementById('investForm').dataset.goalAmount = goalAmount;
            document.getElementById('investForm').dataset.totalTokens = totalTokens;
            document.getElementById('investForm').dataset.profitShare = profitShare;
            document.getElementById('investForm').dataset.ownershipPercentage = ownershipPercentage;
            document.getElementById('investForm').dataset.ownershipPerToken = ownershipPerToken;
            
            // Reset amount field
            document.getElementById('investAmount').value = '';
            document.getElementById('investRange').value = '1';
            updateTokenPreview();
        }

        // Enhanced token preview calculator
        function updateTokenPreview() {
            const amount = parseFloat(document.getElementById('investAmount').value) || 0;
            const form = document.getElementById('investForm');
            const tokenType = form.querySelector('#tokenType').value;
            const goalAmount = parseFloat(form.dataset.goalAmount);
            const totalTokens = parseFloat(form.dataset.totalTokens);
            
            let tokenAmount = 0;
            let tokenValue = '';
            let iconClass = '';
            
            if (tokenType === 'profit') {
                const profitShare = parseFloat(form.dataset.profitShare);
                tokenAmount = (amount / goalAmount) * totalTokens;
                tokenValue = `Earns ${(profitShare * amount / goalAmount).toFixed(2)}% profit share`;
                iconClass = 'bi-graph-up-arrow';
            } 
            else if (tokenType === 'ownership') {
                const ownershipPercentage = parseFloat(form.dataset.ownershipPercentage);
                tokenAmount = (amount * totalTokens) / (goalAmount * (ownershipPercentage / 100));
                tokenValue = `${(ownershipPercentage * amount / goalAmount).toFixed(2)}% equity stake`;
                iconClass = 'bi-building';
            }
            else if (tokenType === 'hybrid') {
                const ownershipPerToken = parseFloat(form.dataset.ownershipPerToken);
                tokenAmount = amount;
                tokenValue = `${ownershipPerToken}% ownership + rewards`;
                iconClass = 'bi-collection';
            }
            
            document.getElementById('previewTokenAmount').innerHTML = `
                <i class="bi ${iconClass}"></i> ${tokenAmount.toFixed(2)} tokens`;
            document.getElementById('previewTokenValue').innerHTML = tokenValue;
            
            // Update visual indicator
            const progress = Math.min((amount / goalAmount) * 100, 100);
            document.querySelector('.investment-progress').style.width = `${progress}%`;
        }

        // Delete confirmation
        function confirmDelete(campaignId) {
            if (confirm('Are you sure you want to delete this campaign? This action cannot be undone.')) {
                fetch(`/campaigns/${campaignId}`, {
                    method: 'DELETE',
                }).then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete campaign');
                    }
                });
            }
        }

        // Form submission loading states
        document.getElementById('investForm')?.addEventListener('submit', function(e) {
            const btn = this.querySelector('button[type="submit"]');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            btn.disabled = true;
        });

        document.getElementById('createCampaignForm')?.addEventListener('submit', function(e) {
            const btn = this.querySelector('button[type="submit"]');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Deploying...';
            btn.disabled = true;
        });
    </script>

<%- include("partials/footer") -%>